<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Qwen3</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styling for chat bubbles */
        .user-bubble {
            background-color: #DCF8C6; /* Light green */
            align-self: flex-end;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        .bot-bubble {
            background-color: #F1F0F0; /* Light gray */
            align-self: flex-start;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            max-width: 80%;
            word-wrap: break-word;
        }
         /* Style markdown elements generated by Marked.js */
        .bot-bubble h1, .bot-bubble h2, .bot-bubble h3, .bot-bubble h4, .bot-bubble h5, .bot-bubble h6 {
            font-weight: bold;
            margin-top: 0.5em;
            margin-bottom: 0.25em;
        }
        .bot-bubble h1 { font-size: 1.5em; }
        .bot-bubble h2 { font-size: 1.25em; }
        .bot-bubble h3 { font-size: 1.1em; }
        .bot-bubble ul, .bot-bubble ol {
            margin-left: 1.5rem;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .bot-bubble ul { list-style-type: disc; }
        .bot-bubble ol { list-style-type: decimal; }
        .bot-bubble code:not(pre code) { /* Style inline code differently */
             background-color: #e2e8f0; /* bg-gray-200 */
             padding: 0.1rem 0.3rem;
             border-radius: 0.25rem;
             font-family: monospace;
             font-size: 0.9em; /* Slightly smaller */
        }
        .bot-bubble pre {
            background-color: #2d3748; /* bg-gray-800 */
            color: #e2e8f0; /* text-gray-200 */
            padding: 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            overflow-x: auto;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-family: monospace;
            font-size: 0.9em;
        }
         .bot-bubble pre code {
             padding: 0;
             background-color: transparent;
             color: inherit; /* Inherit color from pre */
             font-size: inherit; /* Inherit font size */
         }
        .bot-bubble p {
            margin-bottom: 0.5em; /* Add space between paragraphs */
        }
        .bot-bubble p:last-child {
            margin-bottom: 0; /* No space after the last paragraph in a bubble */
        }
        .bot-bubble blockquote {
            border-left: 4px solid #cbd5e0; /* border-gray-400 */
            padding-left: 1rem;
            margin-left: 0;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            color: #4a5568; /* text-gray-700 */
        }
        .bot-bubble strong, .bot-bubble b {
            font-weight: bold;
        }
        .bot-bubble em, .bot-bubble i {
            font-style: italic;
        }
        .bot-bubble a {
            color: #2563eb; /* text-blue-600 */
            text-decoration: underline;
        }
        .bot-bubble hr {
            border-top: 1px solid #cbd5e0; /* border-gray-400 */
            margin-top: 0.75em;
            margin-bottom: 0.75em;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen font-sans">

    <header class="bg-blue-600 text-white p-4 flex justify-between items-center sticky top-0 shadow-md z-10">
        <h1 class="text-xl font-semibold">Qwen3 Chat</h1>
        <!-- Add Clear Chat button -->
        <button id="clear-button"
                class="bg-red-500 text-white rounded-lg p-1 px-3 text-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400">
            Clear Chat
        </button>
    </header>

    <!-- Chat container -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- Chat messages will be appended here -->
        <div class="bot-bubble">
            <p>Hello! Ask me anything.</p>
        </div>
    </div>

    <!-- Input area -->
    <footer class="bg-white p-4 sticky bottom-0 border-t border-gray-200">
        <form id="chat-form" class="flex items-center space-x-2">
            <input type="text" id="message-input" placeholder="Type your message..."
                   class="flex-1 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   autocomplete="off">
            <button type="submit" id="send-button"
                    class="bg-blue-600 text-white rounded-lg p-2 px-4 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50">
                Send
            </button>
        </form>
         <div id="loading-indicator" class="text-center text-gray-500 mt-2 hidden">
             Waiting for response...
         </div>
         <div id="error-message" class="text-center text-red-500 mt-2 hidden"></div>
    </footer>

    <!-- Load Marked.js library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clearButton = document.getElementById('clear-button'); // Get clear button
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');

        // Function to add a message to the chat
        function addMessage(sender, message, isMarkdown = false) {
            const bubble = document.createElement('div');
            bubble.classList.add(sender === 'user' ? 'user-bubble' : 'bot-bubble');

            if (sender === 'bot' && isMarkdown) {
                // Configure marked to handle potential issues like code blocks better
                // Using highlight.js is possible for syntax highlighting but adds complexity.
                // For now, use basic marked parsing with GFM tables and line breaks.
                marked.setOptions({
                    gfm: true, // Use GitHub Flavored Markdown
                    breaks: true, // Convert single line breaks to <br>
                    // sanitize: true, // DEPRECATED in newer versions, enable with caution if needed using DOMPurify
                });
                bubble.innerHTML = marked.parse(message);
            } else {
                 const p = document.createElement('p');
                 p.textContent = message;
                 bubble.appendChild(p);
            }

            chatContainer.appendChild(bubble);
            // Scroll to the bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- Function to clear the chat display ---
        function clearChatDisplay() {
            // Remove all children except the initial bot message if desired,
            // or simply remove all messages. Let's remove all for a clean slate.
             chatContainer.innerHTML = ''; // Clear all messages visually
             // Optionally add back the initial greeting
             addMessage('bot', 'Chat history cleared. Ask me anything!');
        }
        // ------------------------------------------

        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            messageInput.value = '';
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message }),
                });

                if (!response.ok) {
                    let errorText = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (jsonError) {
                         errorText = `${errorText} - ${response.statusText || 'Server error'}`;
                    }
                    throw new Error(errorText);
                }

                const data = await response.json();

                if (data.response) {
                    addMessage('bot', data.response, true);
                } else if (data.error) {
                    throw new Error(data.error);
                }

            } catch (error) {
                console.error('Error sending/receiving message:', error);
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.classList.remove('hidden');
                addMessage('bot', `Sorry, I encountered an error: ${error.message}`);
            } finally {
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                messageInput.focus();
            }
        });

        // --- Add event listener for the Clear Chat button ---
        clearButton.addEventListener('click', async () => {
            console.log('Clear chat button clicked');
            // Disable button temporarily
            clearButton.disabled = true;
            try {
                // Send request to the backend to reset history
                const response = await fetch('/reset', { method: 'POST' });
                if (!response.ok) {
                    throw new Error(`Failed to reset chat history on server. Status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status === 'ok') {
                    // Clear the chat display on the frontend
                    clearChatDisplay();
                    console.log('Chat history cleared successfully.');
                } else {
                    throw new Error('Server responded but did not confirm reset.');
                }
            } catch (error) {
                console.error('Error clearing chat history:', error);
                // Show an error to the user if needed
                errorMessage.textContent = `Error clearing chat: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                 // Re-enable button
                 clearButton.disabled = false;
                 messageInput.focus();
            }
        });
        // ----------------------------------------------------

        // Initial focus on input
        messageInput.focus();

    </script>
</body>
</html>

