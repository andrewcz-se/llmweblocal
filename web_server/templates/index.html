<!DOCTYPE html>
<!-- Add class="" to <html> so JS can toggle 'dark' -->
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with an LLM</title>
    
    <!-- Load Tailwind CSS *first* -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEW: Configure Tailwind for 'class' dark mode *after* loading -->
    <script>
      tailwind.config = {
        darkMode: 'class'
      }
    </script>
    
    <!-- Dark Mode Initializer -->
    <!-- This script runs *before* the page renders to prevent FOUC (Flash Of Unstyled Content) -->
    <script>
        // Apply theme from local storage or system preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- MathJax Configuration -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']], // Recognize $...$ and \(...\)
        displayMath: [['$$', '$$'], ['\\[', '\\]']], // Recognize $$...$$ and \[...\]
        processEscapes: true // Allows using \$ to display a literal dollar sign
      },
      svg: {
        fontCache: 'global' // Use global font cache for better performance
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] // Don't look for math in these tags
      }
    };
    </script>
    <!-- Load MathJax -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Load Marked.js library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Basic styling for chat bubbles (Light Mode) */
        .user-bubble {
            background-color: #DCF8C6; /* Light green */
            color: #1f2937; /* text-gray-800 */
            align-self: flex-end;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        .bot-bubble {
            background-color: #F1F0F0; /* Light gray */
            color: #1f2937; /* text-gray-800 */
            align-self: flex-start;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        /* --- Dark Mode Overrides --- */
        .dark .user-bubble {
            background-color: #047857; /* bg-green-700 */
            color: #F9FAFB; /* text-gray-50 */
        }
        .dark .bot-bubble {
            background-color: #374151; /* bg-gray-700 */
            color: #F9FAFB; /* text-gray-50 */
        }
        /* -------------------------- */


         /* Style markdown elements generated by Marked.js (Light Mode) */
        .bot-bubble h1, .bot-bubble h2, .bot-bubble h3, .bot-bubble h4, .bot-bubble h5, .bot-bubble h6 {
            font-weight: bold;
            margin-top: 0.5em;
            margin-bottom: 0.25em;
        }
        .bot-bubble h1 { font-size: 1.5em; }
        .bot-bubble h2 { font-size: 1.25em; }
        .bot-bubble h3 { font-size: 1.1em; }
        .bot-bubble ul, .bot-bubble ol {
            margin-left: 1.5rem;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .bot-bubble ul { list-style-type: disc; }
        .bot-bubble ol { list-style-type: decimal; }
        
        .bot-bubble code:not(pre code) { /* Style inline code differently */
             background-color: #e2e8f0; /* bg-gray-200 */
             color: #2d3748; /* text-gray-800 */
             padding: 0.1rem 0.3rem;
             border-radius: 0.25rem;
             font-family: monospace;
             font-size: 0.9em; /* Slightly smaller */
        }
        .bot-bubble pre {
            background-color: #2d3748; /* bg-gray-800 */
            color: #e2e8f0; /* text-gray-200 */
            padding: 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            overflow-x: auto;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-family: monospace;
            font-size: 0.9em;
        }
         .bot-bubble pre code {
             padding: 0;
             background-color: transparent;
             color: inherit; /* Inherit color from pre */
             font-size: inherit; /* Inherit font size */
         }
        .bot-bubble p {
            margin-bottom: 0.5em; /* Add space between paragraphs */
        }
        .bot-bubble p:last-child {
            margin-bottom: 0; /* No space after the last paragraph in a bubble */
        }
        .bot-bubble blockquote {
            border-left: 4px solid #cbd5e0; /* border-gray-400 */
            padding-left: 1rem;
            margin-left: 0;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            color: #4a5568; /* text-gray-700 */
        }
        .bot-bubble strong, .bot-bubble b {
            font-weight: bold;
        }
        .bot-bubble em, .bot-bubble i {
            font-style: italic;
        }
        .bot-bubble a {
            color: #2563eb; /* text-blue-600 */
            text-decoration: underline;
        }
        .bot-bubble hr {
            border-top: 1px solid #cbd5e0; /* border-gray-400 */
            margin-top: 0.75em;
            margin-bottom: 0.75em;
        }

        /* --- Dark Mode Overrides for Markdown --- */
        .dark .bot-bubble code:not(pre code) {
             background-color: #4B5563; /* bg-gray-600 */
             color: #E5E7EB; /* text-gray-200 */
        }
        .dark .bot-bubble pre {
             background-color: #1F2937; /* bg-gray-800 (slightly different from light) */
             color: #E5E7EB; /* text-gray-200 */
        }
        .dark .bot-bubble blockquote {
            border-left-color: #4B5563; /* border-gray-600 */
            color: #9CA3AF; /* text-gray-400 */
        }
        .dark .bot-bubble a {
            color: #60A5FA; /* text-blue-400 */
        }
        .dark .bot-bubble hr {
            border-top-color: #4B5563; /* border-gray-600 */
        }
        /* ------------------------------------- */

        /* Style MathJax math */
        mjx-container {
            overflow-x: auto; /* Allow horizontal scroll for long equations */
            overflow-y: hidden;
            max-width: 100%;
        }
    </style>
</head>
<!-- Add dark mode classes for body -->
<body class="bg-gray-100 flex flex-col h-screen font-sans dark:bg-gray-900 dark:text-gray-200">

    <!-- Add dark mode classes for header -->
    <header class="bg-blue-600 text-white p-4 flex justify-between items-center sticky top-0 shadow-md z-10 dark:bg-gray-800">
        <h1 class="text-xl font-semibold">LLM Chat</h1>
        <!-- Container for buttons -->
        <div class="flex items-center space-x-2">
            <!-- NEW Theme Toggle Button -->
            <button id="theme-toggle"
                    class="bg-blue-700 text-white rounded-lg p-1.5 px-2 text-sm hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:hover:bg-gray-600">
                <!-- Moon icon (hidden by default, shown in light mode) -->
                <svg id="theme-icon-dark" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
                <!-- Sun icon (hidden by default, shown in dark mode) -->
                <svg id="theme-icon-light" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            </button>
            <!-- Clear Chat Button -->
            <button id="clear-button"
                    class="bg-red-500 text-white rounded-lg p-1 px-3 text-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 dark:bg-red-600 dark:hover:bg-red-700">
                Clear Chat
            </button>
        </div>
    </header>

    <!-- Chat container -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="bot-bubble">
            <p>Hello! Ask me anything. I can now render math like $ E = mc^2 $.</p>
            <p>Toggle dark / light mode with the button in the header.</p>
        </div>
    </div>

    <!-- Input area (add dark mode classes) -->
    <footer class="bg-white p-4 sticky bottom-0 border-t border-gray-200 dark:bg-gray-800 dark:border-gray-700">
        <form id="chat-form" class="flex items-center space-x-2">
            <input type="text" id="message-input" placeholder="Type your message..."
                   class="flex-1 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
                   autocomplete="off">
            <button type="submit" id="send-button"
                    class="bg-blue-600 text-white rounded-lg p-2 px-4 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 dark:bg-blue-700 dark:hover:bg-blue-800">
                Send
            </button>
        </form>
         <div id="loading-indicator" class="text-center text-gray-500 mt-2 hidden dark:text-gray-400">
             Waiting for response...
         </div>
         <div id="error-message" class="text-center text-red-500 mt-2 hidden dark:text-red-400"></div>
    </footer>

    <script>
        // Get all DOM elements
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clearButton = document.getElementById('clear-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        
        // NEW: Get theme toggle elements
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const themeIconLight = document.getElementById('theme-icon-light');

        // Function to add a message to the chat
        function addMessage(sender, message, isMarkdown = false) {
            const bubble = document.createElement('div');
            bubble.classList.add(sender === 'user' ? 'user-bubble' : 'bot-bubble');
            let needsMathJax = false; // Flag to check if MathJax processing is needed

            if (sender === 'bot' && isMarkdown) {
                marked.setOptions({
                    gfm: true,
                    breaks: true,
                });
                bubble.innerHTML = marked.parse(message);
                // Check if the original message likely contained math delimiters
                if (message.includes('$') || message.includes('\\(') || message.includes('\\[')) {
                    needsMathJax = true;
                }
            } else {
                 const p = document.createElement('p');
                 p.textContent = message;
                 bubble.appendChild(p);
            }

            chatContainer.appendChild(bubble); // Append the bubble to the DOM

            // --- Tell MathJax to typeset the *new* bubble IF needed ---
            if (needsMathJax && typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                 MathJax.typesetPromise([bubble])
                    .catch((err) => console.error('MathJax Typeset Error:', err));
            }
            // --------------------------------------------------------

            // Scroll to the bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- Function to clear the chat display ---
        function clearChatDisplay() {
             chatContainer.innerHTML = '';
             addMessage('bot', 'Chat history cleared. Ask me anything!');
        }
        // ------------------------------------------

        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            messageInput.value = '';
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message }),
                });

                if (!response.ok) {
                    let errorText = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (jsonError) {
                         errorText = `${errorText} - ${response.statusText || 'Server error'}`;
                    }
                    throw new Error(errorText);
                }

                const data = await response.json();

                if (data.response) {
                    addMessage('bot', data.response, true);
                } else if (data.error) {
                    throw new Error(data.error);
                }

            } catch (error) {
                console.error('Error sending/receiving message:', error);
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.classList.remove('hidden');
                addMessage('bot', `Sorry, I encountered an error: ${error.message}`);
            } finally {
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                messageInput.focus();
            }
        });

        // --- Add event listener for the Clear Chat button ---
        clearButton.addEventListener('click', async () => {
            console.log('Clear chat button clicked');
            clearButton.disabled = true;
            try {
                const response = await fetch('/reset', { method: 'POST' });
                if (!response.ok) {
                    throw new Error(`Failed to reset chat history on server. Status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status === 'ok') {
                    clearChatDisplay();
                    console.log('Chat history cleared successfully.');
                } else {
                    throw new Error('Server responded but did not confirm reset.');
                }
            } catch (error) {
                console.error('Error clearing chat history:', error);
                errorMessage.textContent = `Error clearing chat: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                 clearButton.disabled = false;
                 messageInput.focus();
            }
        });
        // ----------------------------------------------------

        // --- NEW: Theme Toggle Setup ---
        
        // Function to update the icon based on the current theme
        function updateThemeIcon() {
            if (document.documentElement.classList.contains('dark')) {
                themeIconDark.classList.remove('hidden');
                themeIconLight.classList.add('hidden');
            } else {
                themeIconDark.classList.add('hidden');
                themeIconLight.classList.remove('hidden');
            }
        }

        // Event listener for the toggle button
        themeToggle.addEventListener('click', () => {
            // Toggle the 'dark' class on the <html> element
            document.documentElement.classList.toggle('dark');
            
            // Update localStorage with the new preference
            if (document.documentElement.classList.contains('dark')) {
                localStorage.theme = 'dark';
            } else {
                localStorage.theme = 'light';
            }
            
            // Update the button icon
            updateThemeIcon();
        });
        // ---------------------------

        // Initial focus on input
        messageInput.focus();

        // Optional: Run MathJax on the initial message after page load
        document.addEventListener('DOMContentLoaded', () => {
             if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                 MathJax.typesetPromise(); // Typeset the whole page initially
             }
             // Set the correct theme icon as soon as the DOM is loaded
             updateThemeIcon(); 
        });

    </script>
</body>
</html>

